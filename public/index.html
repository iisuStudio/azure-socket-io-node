<!doctype html>
<html lang="">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="css/emoji.css">
    <link rel="shortcut icon" type="image/png" href="favicon.png"/>
    <link rel="shortcut icon" type="image/png" href="favicon.png"/>
    <!-- Title -->
    <title>Durarara! Chat!</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font: 13px Helvetica, Arial;
        }

        form {
            background: #000;
            /*padding: 3px;*/
            position: fixed;
            bottom: 0;
            width: 100%;
        }

        /*form input {*/
        /*border: 0;*/
        /*padding: 10px;*/
        /*width: 90%;*/
        /*margin-right: .5%;*/
        /*}*/

        /*form button {*/
        /*width: 9%;*/
        /*background: rgb(130, 224, 255);*/
        /*border: none;*/
        /*padding: 10px;*/
        /*}*/

        #messages {
            list-style-type: none;
            margin: 0;
            padding: 0;
        }

        #messages li {
            padding: 5px 10px;
        }

        #messages li:nth-child(odd) {
            background: #eee;
        }

        #messages {
            margin-bottom: 40px
        }

        .chatroom {
            margin-top: 5rem;
            margin-bottom: 10rem;
        }

        .dialog {
            margin-bottom: 1.5rem;
        }

        .image-box {
            min-width: 60px;
            width: 10%;
        }

        .image-box > img {
            max-height: 100px;
            max-width: 100px;
            width: 100%;
        }

        .message-arrow-icon {
            margin-left: 1rem;
        }

        .message-arrow-icon > svg {
            width: 1rem;
            height: 1rem;
            margin-top: 1rem;
            overflow: visible;
        }

        @media (max-width: 576px) {
            body {
                font-size: 16px;
            }
            .message-box {
                border: #fff 3px solid;
                border-radius: .5rem;
                padding: 1rem;
            }
        }

        @media (min-width: 576px) {
            body {
                font-size: 22px;
            }
            .message-box {
                border: #fff 5px solid;
                border-radius: 1rem;
                padding: 2rem;
            }
        }

        .message {
            min-height: 1rem;
            min-width: 1rem;
        }

        .track {
            fill: white;
            stroke: white;
            stroke-width: 2;
        }

        .track-round {
            stroke-linejoin: round;
        }

        .track-reverse {
            transform: scale(1, 1) scale(-1, 1);
        }

        .emoji-wysiwyg-editor {
            height: 5rem!important;
        }
        .emoji-menu {
            bottom: 5rem;
        }
    </style>
</head>
<body class="bg-dark">
<div class="container container-fluid">
    <!-- content -->
    <div class="chatroom">

    </div>
</div>
<form class="p-2" action="">
    <div class="form-group mx-md-5 mb-2 ">
        <label for="m" class="sr-only">訊息</label>
        <p class="lead emoji-picker-container">
            <input class="form-control" title="訊息" placeholder="message..." id="m" data-emojiable="true" autocomplete="off" />
        </p>
    </div>
    <div class="mx-md-5">
        <button class="btn btn-dark" style="width: 100%">POST!</button>
    </div>
</form>
<script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
<script src="js/config.js"></script>
<script src="js/util.js"></script>
<script src="js/jquery.emojiarea.js"></script>
<script src="js/emoji-picker.js"></script>
<script>
    $(function() {
        // Initializes and creates emoji set from sprite sheet
        window.emojiPicker = new EmojiPicker({
            emojiable_selector: '[data-emojiable=true]',
            assetsPath: '/img/',
            popupButtonClasses: 'fa fa-smile-o'
        });
        // Finds all elements with `emojiable_selector` and converts them to rich emoji input fields
        // You may want to delay this step if you have dynamically created input fields that appear later in the loading process
        // It can be called as many times as necessary; previously converted input fields will not be converted again
        window.emojiPicker.discover();
    });
</script>
<script>
    $(function () {
        var rand = function () {
            return Math.random().toString(36).substr(2); // remove `0.`
        };

        var token = function () {
            return rand() + rand(); // to make it longer
        };

        var uuid = token(); // "bnh5yzdirjinqaorq0ox1tf383nb3xr"
        //
        var hosts = [
            'http://iisustudio-socket-io-node.azurewebsites.net:80',
            'http://iisustudio-socket-io-node-0.azurewebsites.net:80',
            'http://iisustudio-socket-io-node-1.azurewebsites.net:80',
        ];
        var socket = null;
        for (var i=0; i<hosts.length; i++) {
            try {
                socket = io(hosts[i]);
                break;
            } catch (e) {

            }
        }

        $('form').submit(function () {
            socket.emit('chat_message', uuid + '||' + $('#m').val());
            $('#m').val("");
            $('.emoji-wysiwyg-editor').text('');
            return false;
        });
        $('.emoji-wysiwyg-editor').on("keyup", function(event) {
            // Number 13 is the "Enter" key on the keyboard
            if (event.keyCode === 13) {
                // Cancel the default action, if needed
                event.preventDefault();
                $('#m').val($(this).text());
                // Trigger the button element with a click
                $('form').submit()
            }
        });
        socket.on('chat_message', function (msg) {
            if (msg && msg.split('||')) {
                var me = msg.split('||')[0];
                var text = msg.split('||')[1];

                if (uuid === me) {
                    var dom = `<div class="d-flex flex-row-reverse bd-highlight dialog">
                            <div class="image-box">
                                <img class="img-thumbnail" src="img/head_icons/1.png" alt="...">
                            </div>
                            <div class="message-arrow-icon">
                                <svg>
                                    <polygon class="track track-round track-reverse" points="20,5 0,10, 10,15 15,18 17,20 20,25"/>
                                </svg>
                            </div>
                            <div>
                                <div class="message-box bd-highlight bg-info">
                                    <div class="message text-break text-light text-monospace">${text}</div>
                                </div>
                            </div>
                        </div>`;
                } else {
                    var dom = `<div class="d-flex flex-row bd-highlight dialog">
                            <div class="image-box">
                                <img class="img-thumbnail" src="img/head_icons/2.png" alt="...">
                            </div>
                            <div class="message-arrow-icon">
                                <svg>
                                    <polygon class="track track-round" points="20,5 0,10, 10,15 15,18 17,20 20,25"/>
                                </svg>
                            </div>
                            <div>
                                <div class="message-box bd-highlight bg-info">
                                    <div class="message text-break text-light text-monospace">${text}</div>
                                </div>
                            </div>
                        </div>`;
                }
                $('.chatroom').append(dom);
                window.scrollTo(0, document.body.scrollHeight);
                var audio = new Audio('notification.mp3');
                audio.play();
            }
        });
    });
</script>
</body>
</html>
